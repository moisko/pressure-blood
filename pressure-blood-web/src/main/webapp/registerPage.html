<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Register Form</title>
<link rel="stylesheet" type="text/css" href="styles/registerPage.css">
<script src="scripts/jquery-1.10.2.js"></script>
<script src="scripts/jquery.validate.js"></script>
<script>

	var reloadPage = function() {
		window.location.reload();
	};

	var getUsername = function() {
		return $("#username").val();
	}

	var getPassword1 = function() {
		return $("#password1").val();
	}

	var getPassword2 = function() {
		return $("#password2").val();
	}

	var getEmail = function() {
		return $("#email").val();
	}

	var registerUser = function() {
		$.ajax({
			url : "/pressure-blood-web/RegisterNewUserServlet",
			type : "POST",
			dataType : "json",
			contentType : "application/json; charset=utf-8",
			data : JSON.stringify({
				"username" : getUsername(),
				"password1" : getPassword1(),
				"password2" : getPassword2(),
				"email" : getEmail()
			}),
			success : function(json) {
				var status = json.status;
				switch (status) {
					case "SUCCESS" :
						window.location.href = "/pressure-blood-web/GetMeasures";
						break;
					case "EXISTS":
					case "ERROR":
						alert(json.message);
						reloadPage();
						break;
				}
			},
			error : function(json) {
				alert(json.responseJSON.message);
				reloadPage();
			}
		});
	};

	var validateRegisterForm = function() {
		$("#registerForm").validate({
			rules: {
				username: {
					required: true,
					minlength: 2
				},
				password1: {
					required: true,
					minlength: 4
				},
				password2: {
					required: true,
					minlength: 4,
					equalTo: "#password1"
				},
				email: {
					required: true,
					email: true
				}
			},
			messages: {
				username: {
					required: "Username is required",
					minlength: $.format("At least {0} characters required")
				},
				password1: {
					required: "Password is required",
					minlength: $.format("At least {0} characters required")
				},
				password2: {
					required: "Confirm password is required",
					minlength: $.format("At least {0} characters required")
				},
				email: {
					required: "Email is required",
					email: $.format("Email is not valid")
				}
			},
			highlight: function(element, errorClass, validClass) {
				$(element).addClass(errorClass).removeClass(validClass);
			},
			unhighlight: function(element, errorClass, validClass) {
				$(element).removeClass(errorClass).addClass(validClass);
			}
		});
	};

	var isRegisterFormValid = function() {
		return $("#registerForm").valid();
	};

	// When the browser is ready
	$(function() {
		$("#registerForm").submit(function(event) {
			validateRegisterForm();
			if(isRegisterFormValid()) {
				registerUser();
			}
			event.preventDefault();
		});
	});

</script>
</head>
<body>
	<div class="center">
		<form id="registerForm" method="post" action="">
			<fieldset>
				<legend>Register to Web App</legend>
				<table>
					<tbody>
						<tr>
							<td>
								<label for="username">Username*:</label>
								<input id="username" name="username" type="text" value="" autocomplete="off" class="required">
							</td>
						</tr>
						<tr>
							<td>
								<label for="password1">Password*:</label>
								<input id="password1" name="password1" type="password" value="" autocomplete="off" class="required">
							</td>
						</tr>
						<tr>
							<td>
								<label for="password2">Confirm password*:</label>
								<input id="password2" name="password2" type="password" value="" autocomplete="off" class="required">
							</td>
						</tr>
						<tr>
							<td>
								<label for="email">Email*:</label>
								<input id="email" name="email" type="text" name="" value="" autocomplete="off" class="required">
							</td>
						</tr>
						<tr>
							<td>
								<a href="loginPage.html">Back to Login page</a>
								<button type="submit">Register and Login</button>
							</td>
						</tr>
					</tbody>
				</table>
			</fieldset>
		</form>
	</div>
</body>
</html>